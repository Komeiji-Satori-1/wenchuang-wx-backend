{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è®¢å•ç»Ÿè®¡åˆ†æ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'plugins/bootstrap-5.3.8-dist/css/bootstrap.css' %}">
    <script src="{% static 'js/jquery-3.7.1.js' %}"></script>
    <script src="{% static 'plugins/bootstrap-5.3.8-dist/js/bootstrap.js' %}"></script>

    <!-- Chart.js è„šæœ¬å·²ç§»è‡³ </body> ä¹‹å‰ï¼Œä»¥ç¡®ä¿æ­£ç¡®åŠ è½½é¡ºåº -->

    <style>
        body {
            background-color: #f7f9fb;
        }
        .chart-container {
            width: 90%;
            max-width: 1200px;
            margin: 40px auto;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .chart-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }
        .btn-group {
            text-align: center;
            margin-bottom: 25px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* ç¡®ä¿åœ¨å°å±å¹•ä¸Šæ¢è¡Œ */
        }
        .back-btn {
            position: absolute;
            top: 20px;
            right: 40px;
        }

        /* æ ¸å¿ƒï¼šå¯æ»šåŠ¨çš„å›¾è¡¨å¤–å±‚å®¹å™¨ */
        .chart-scroll-container {
            width: 100%;
            overflow-x: auto; /* å…è®¸æ°´å¹³æ»šåŠ¨ */
            overflow-y: hidden;
            padding-bottom: 8px; /* ä¸ºæ»šåŠ¨æ¡ç•™å‡ºç©ºé—´ */
        }

        /* åŠ¨æ€å¯æ‰©å±•çš„canvaså®¹å™¨ */
        #salesChart {
            display: block;
            min-width: 100%; /* ç¡®ä¿åœ¨æ•°æ®å°‘æ—¶è‡³å°‘å æ»¡å®¹å™¨ */
            height: 450px !important;  /* å›ºå®šè¾ƒé«˜çš„æ˜¾ç¤ºåŒºåŸŸ */
        }

        /* æ–°å¢ï¼šé¥¼çŠ¶å›¾å®¹å™¨æ ·å¼ï¼Œç¡®ä¿å…¶åœ¨ç§»åŠ¨ç«¯å‹å¥½ */
        .pie-chart-wrapper {
            max-width: 500px; /* é™åˆ¶é¥¼å›¾çš„æœ€å¤§å®½åº¦ï¼Œä½¿å…¶å±…ä¸­ç¾è§‚ */
            margin: 0 auto;
        }

        /* ç¾åŒ–æ»šåŠ¨æ¡ */
        .chart-scroll-container::-webkit-scrollbar {
            height: 8px;
        }
        .chart-scroll-container::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 4px;
        }
        .chart-scroll-container::-webkit-scrollbar-track {
            background: #f3f4f6;
        }
    </style>
</head>
<body>

<div class="container mt-5">
    <h2 class="mb-4">ğŸ“Š é”€å”®ç»Ÿè®¡åˆ†æ</h2>
    <!-- æ³¨æ„ï¼šæ­¤å¤„é“¾æ¥å¯èƒ½éœ€è¦æ ¹æ®æ‚¨çš„URLé…ç½®è°ƒæ•´ -->
    <a href="{% url 'orders:order_home' %}" class="btn btn-secondary back-btn">æŸ¥çœ‹è®¢å•è¯¦æƒ…</a>
    <a href="/index/" class="btn btn-secondary">ğŸ  è¿”å›ä¸»é¡µ</a>

    <!-- 1. æœˆé”€å”®é¢è¶‹åŠ¿å›¾ (åŸå›¾è¡¨) -->
    <div class="chart-container">
        <div class="chart-title">æœˆé”€å”®é¢è¶‹åŠ¿</div>

        <!-- æŒ‰é’®ç»„ -->
        <div class="btn-group" role="group" aria-label="Time Range Controls">
            <button class="btn btn-outline-primary btn-sm" onclick="updateRange(6)">æœ€è¿‘6ä¸ªæœˆ</button>
            <button class="btn btn-outline-primary btn-sm" onclick="updateRange(12)">æœ€è¿‘12ä¸ªæœˆ</button>
            <button class="btn btn-outline-primary btn-sm" onclick="updateRange('all')">å…¨éƒ¨</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="resetZoom()">é‡ç½®ç¼©æ”¾</button>
        </div>

        <!-- æ»šåŠ¨å®¹å™¨ -->
        <div class="chart-scroll-container">
            <canvas id="salesChart"></canvas>
        </div>
    </div>

    <!-- 2. äº§å“é”€å”®é‡åˆ†å¸ƒå›¾ (æ–°å¢é¥¼çŠ¶å›¾) -->
    <div class="chart-container mt-5">
        <div class="chart-title">ğŸ† çƒ­é—¨äº§å“é”€é‡åˆ†å¸ƒ (Top 5)</div>

        <!-- æŒ‰é’®ç»„ -->
        <div class="btn-group" role="group" aria-label="Product Time Range Controls">
            <button class="btn btn-outline-success btn-sm" onclick="updateProductRange('all')">å…¨éƒ¨æ—¶é—´</button>
            <button class="btn btn-outline-success btn-sm" onclick="updateProductRange(12)">æœ€è¿‘12ä¸ªæœˆ</button>
            <button class="btn btn-outline-success btn-sm" onclick="updateProductRange(3)">æœ€è¿‘3ä¸ªæœˆ</button>
        </div>

        <!-- é¥¼çŠ¶å›¾å®¹å™¨ -->
        <div class="pie-chart-wrapper">
            <canvas id="productSalesChart"></canvas>
        </div>
    </div>

</div>

<!-- å¼•å…¥ Chart.js ä¸ ç¼©æ”¾æ’ä»¶ (ç§»åŠ¨åˆ°è¿™é‡Œç¡®ä¿å®ƒä»¬åœ¨ä¸»è„šæœ¬è¿è¡Œå‰å·²åŠ è½½) -->
<script src="{% static 'js/chart.js' %}"></script>
<script src="{% static 'js/chartjs-plugin-zoom.min.js' %}"></script>

<script>
    // ----------------------------------------------------
    // I. é”€å”®é¢è¶‹åŠ¿å›¾ (Sales Chart) é€»è¾‘
    // ----------------------------------------------------
    let salesChart = null;
    const allLabels = JSON.parse('{{ sales_labels_json | safe }}');
    const allData = JSON.parse('{{ sales_data_json | safe }}')

    function getData(range) {
        if (range === 'all') {
            return { labels: allLabels, data: allData };
        }
        const count = parseInt(range);
        return {
            labels: allLabels.slice(-count),
            data: allData.slice(-count)
        };
    }

    function calculateCanvasWidth(labelCount) {
        const minWidth = 600;
        const dynamicWidth = Math.max(minWidth, labelCount * 80 + 100);
        return dynamicWidth;
    }

    function updateRange(range) {
        const { labels, data } = getData(range);
        const canvas = document.getElementById("salesChart");
        canvas.style.width = calculateCanvasWidth(labels.length) + 'px';

        if (salesChart) {
            salesChart.data.labels = labels;
            salesChart.data.datasets[0].data = data;
            salesChart.update('none');
            salesChart.resetZoom();
        }
    }

    function resetZoom() {
        if (salesChart) {
            salesChart.resetZoom();
        }
    }

    // ----------------------------------------------------
    // II. äº§å“é”€å”®é‡å›¾ (Product Chart) é€»è¾‘
    // ----------------------------------------------------
    let productSalesChart = null;
    // æ¨¡æ‹Ÿæ•°æ®: åŒ…å«æ‰€æœ‰æœˆä»½çš„äº§å“é”€å”®é‡ (æŒ‰äº§å“åç§°ç´¢å¼•é¡ºåº)
    const allProductSalesData = JSON.parse('{{ product_detail_json | safe }}');

    /**
     * æ ¹æ®æ—¶é—´èŒƒå›´è®¡ç®— Top 5 äº§å“é”€å”®é‡
     * @param {number|string} range - è¦è®¡ç®—çš„æœˆæ•° (3, 12) æˆ– 'all'
     * @returns {object} { labels: Array<string>, data: Array<number> }
     */
    function getTopProductSales(range) {
        let dataSlice;

        if (range === 'all') {
            dataSlice = allProductSalesData;
        } else {
            const count = parseInt(range);
            dataSlice = allProductSalesData.slice(-count);
        }

        // 1. åˆå§‹åŒ–äº§å“æ€»é”€é‡æ•°ç»„
        const totalQuantities = Array(allProductSalesData.length).fill(0);

        // 2. èšåˆæ•°æ®: ç´¯åŠ æ¯ä¸ªäº§å“çš„æ€»é”€é‡
        dataSlice.forEach(monthData => {
            monthData.qty.forEach((q, index) => {
                totalQuantities[index] += q;
            });
        });

        // 3. å°†é”€é‡å’Œåç§°ç»„åˆæˆå¯¹è±¡æ•°ç»„
        const productData = allProductSalesData.map((name, index) => ({
            name: name,
            quantity: totalQuantities[index]
        }));

        // 4. æ’åºå¹¶è·å– Top 5
        productData.sort((a, b) => b.quantity - a.quantity);

        const topProducts = productData.slice(0, 5);
        const remainingProducts = productData.slice(5);

        let otherQuantity = 0;
        remainingProducts.forEach(p => {
            otherQuantity += p.quantity;
        });

        // 5. æ„å»ºæœ€ç»ˆç”¨äºå›¾è¡¨çš„æ•°æ®
        const chartLabels = topProducts.map(p => p.name);
        const chartData = topProducts.map(p => p.quantity);

        // 6. å¦‚æœæœ‰å‰©ä½™äº§å“ï¼Œåˆ™æ·»åŠ â€œå…¶ä»–â€
        if (otherQuantity > 0) {
            chartLabels.push("å…¶ä»–äº§å“");
            chartData.push(otherQuantity);
        }

        return { labels: chartLabels, data: chartData };
    }


    const backgroundColors = [
        'rgba(255, 99, 132, 0.8)', // çº¢è‰² (Top 1)
        'rgba(54, 162, 235, 0.8)',  // è“è‰² (Top 2)
        'rgba(255, 206, 86, 0.8)', // é»„è‰² (Top 3)
        'rgba(75, 192, 192, 0.8)', // ç»¿è‰² (Top 4)
        'rgba(153, 102, 255, 0.8)',// ç´«è‰² (Top 5)
        'rgba(201, 203, 207, 0.8)' // ç°è‰² (å…¶ä»–)
    ];

    /**
     * æ›´æ–°äº§å“é¥¼çŠ¶å›¾çš„æ•°æ®å’ŒèŒƒå›´
     * @param {number|string} range
     */
    function updateProductRange(range) {
        const { labels, data } = getTopProductSales(range);

        if (productSalesChart) {
            productSalesChart.data.labels = labels;
            productSalesChart.data.datasets[0].data = data;
            productSalesChart.data.datasets[0].backgroundColor = backgroundColors.slice(0, labels.length);
            productSalesChart.update('none');
        }
    }


    // ----------------------------------------------------
    // III. åˆå§‹åŒ–å‡½æ•°
    // ----------------------------------------------------
    document.addEventListener("DOMContentLoaded", function() {
        // --- 1. åˆå§‹åŒ– é”€å”®é¢è¶‹åŠ¿å›¾ ---
        const ctxSales = document.getElementById('salesChart').getContext('2d');
        const defaultSalesRange = 6;
        const { labels: salesLabels, data: salesData } = getData(defaultSalesRange);
        const salesCanvas = document.getElementById("salesChart");

        salesCanvas.style.width = calculateCanvasWidth(salesLabels.length) + 'px';

        salesChart = new Chart(ctxSales, {
            type: "bar",
            data: {
                labels: salesLabels,
                datasets: [{
                    label: "é”€å”®é¢ (Â¥)",
                    data: salesData,
                    backgroundColor: "rgba(54, 162, 235, 0.7)",
                    hoverBackgroundColor: "rgba(54, 162, 235, 1)",
                    borderRadius: 6,
                    borderWidth: 1,
                    borderColor: "rgba(54, 162, 235, 1)"
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: "top" },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    },
                    zoom: {
                        zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x', },
                        pan: { enabled: true, mode: 'x', modifierKey: 'alt', }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'é”€å”®é¢ (Â¥)' },
                        ticks: {
                             callback: function(value, index, values) {
                                 return 'Â¥' + value.toLocaleString('zh-CN');
                             }
                         }
                    },
                    x: {
                        title: { display: true, text: 'æœˆä»½' },
                        ticks: { color: "#555" }
                    }
                }
            }
        });

        // é¦–æ¬¡åŠ è½½åï¼Œå°†æ»šåŠ¨æ¡ç§»åŠ¨åˆ°æœ€å³è¾¹ï¼ˆæœ€æ–°æ•°æ®ï¼‰
        const scrollContainer = document.querySelector('.chart-scroll-container');
        if (scrollContainer) {
            setTimeout(() => {
                scrollContainer.scrollLeft = scrollContainer.scrollWidth;
            }, 100);
        }

        // --- 2. åˆå§‹åŒ– äº§å“é”€å”®é‡åˆ†å¸ƒå›¾ ---
        const ctxProduct = document.getElementById('productSalesChart').getContext('2d');
        const defaultProductRange = 'all'; // é»˜è®¤å±•ç¤ºå…¨éƒ¨æ—¶é—´
        const { labels: productLabels, data: productData } = getTopProductSales(defaultProductRange);

        productSalesChart = new Chart(ctxProduct, {
            type: "pie",
            data: {
                labels: productLabels,
                datasets: [{
                    data: productData,
                    backgroundColor: backgroundColors.slice(0, productLabels.length),
                    hoverOffset: 15,
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'right', // é¥¼å›¾å›¾ä¾‹æ”¾åœ¨å³ä¾§
                        labels: {
                            padding: 20
                        }
                    },
                    tooltip: {
                        callbacks: {
                            // è‡ªå®šä¹‰æç¤ºæ¡†å†…å®¹ï¼Œæ˜¾ç¤ºç™¾åˆ†æ¯”
                            label: function(context) {
                                let label = context.label || '';
                                if (label) { label += ': '; }

                                const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                                const value = context.parsed;
                                const percentage = ((value / total) * 100).toFixed(1) + '%';
                                label += `${value.toLocaleString('zh-CN')} ä»¶ (${percentage})`;
                                return label;
                            }
                        }
                    }
                }
            }
        });
    });

</script>

</body>
</html>

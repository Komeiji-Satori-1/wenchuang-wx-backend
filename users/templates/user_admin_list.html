{% load static %}

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>用户与管理员列表</title>
    <link rel="stylesheet" href="{% static 'plugins/bootstrap-5.3.8-dist/css/bootstrap.css' %}">
    <script src="{% static 'js/jquery-3.7.1.js' %}"></script>
    <script src="{% static 'plugins/bootstrap-5.3.8-dist/js/bootstrap.js' %}"></script>
    <link rel="stylesheet" href="{% static 'plugins/DataTable/css/dataTables.bootstrap5.min.css' %}">
    <script src="{% static 'js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'plugins/DataTable/js/dataTables.bootstrap5.min.js' %}"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }

        h2 {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* 表格宽度与布局优化 */
        .dataTables_wrapper {
            width: 100%;
            overflow-x: auto;
        }

        table.dataTable {
            width: 100% !important;
            text-align: center;
            vertical-align: middle;
        }

        /* 表头深色背景 */
        table.dataTable thead th {
            background-color: #343a40 !important;
            color: white;
            text-align: center;
        }

        /* 单元格间距 */
        table.dataTable td, table.dataTable th {
            padding: 10px 12px;
            vertical-align: middle;
        }

        /* 圆形头像 */
        table.dataTable td img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Bootstrap 卡片样式 */
        .card {
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .dataTables_length, .dataTables_filter {
            margin-bottom: 15px;
        }

        .nav-tabs {
            justify-content: center;
            margin-bottom: 20px;
        }

        .container {
            max-width: 90%;
        }
    </style>
</head>

<body>
<div class="container mt-4">
    <h2>用户与管理员列表</h2>
    <div class="p-3 bg-light border-bottom d-flex align-items-center">
      <a href="{% url 'index' %}" class="btn btn-outline-secondary btn-sm">
        ← 返回首页
      </a>
      <h4 class="ms-3 mb-0">用户列表</h4>
    </div>

    <!-- 切换选项卡 -->
    <ul class="nav nav-tabs" id="userTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="user-tab" data-bs-toggle="tab" data-bs-target="#user" type="button" role="tab">普通用户</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button" role="tab">管理员</button>
        </li>
    </ul>

    <!-- 内容区域 -->
    <div class="tab-content" id="userTabsContent">

        <!-- 普通用户表格 -->
        <div class="tab-pane fade show active" id="user" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <table id="userTable" class="table table-striped table-bordered table-hover">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>头像</th>
                            <th>昵称</th>
                            <th>OpenID</th>
                            <th>创建时间</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for user in users %}
                            <tr>
                                <td>{{ user.id }}</td>
                                <td>
                                    {% if user.avatar_url %}
                                        <img src="{{ user.avatar_url }}" alt="头像">
                                    {% else %}
                                        <img src="{% static 'img/defaultAvatar.jpg' %}" alt="默认头像">
                                    {% endif %}
                                </td>
                                <td>{{ user.nickname|default:"（未命名）" }}</td>
                                <td>{{ user.openid }}</td>
                                <td>{{ user.created_at|date:"Y-m-d H:i" }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 管理员表格 -->
        <div class="tab-pane fade" id="admin" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <table id="adminTable" class="table table-striped table-bordered table-hover">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>用户名</th>
                            <th>创建时间</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for admin in admins %}
                            <tr>
                                <td>{{ admin.id }}</td>
                                <td>{{ admin.username }}</td>
                                <td>{{ admin.created_at|date:"Y-m-d H:i" }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
$(document).ready(function() {

    // 普通用户表格（AJAX 加载）
    const userTable = $('#userTable').DataTable({
        serverSide: true,       // ✅ 开启后端分页模式
        processing: true,       // 显示加载提示
        ajax: function (data, callback) {
            // data.start: 起始记录数, data.length: 每页条数
            const page = Math.floor(data.start / data.length) + 1;
            $.getJSON(`user_list/?page=${page}&per_page=${data.length}`, function(res) {
                callback({
                    recordsTotal: res.total,
                    recordsFiltered: res.total,
                    data: res.data
                });
            });
        },
        columns: [
            { data: 'id' },
            {
                data: 'avatar_url',
                render: function(data) {
                    const avatar = data ? data : "{% static 'img/defaultAvatar.jpg' %}";
                    return `<img src="${avatar}" class="rounded-circle" width="45" height="45">`;
                }
            },
            { data: 'nickname' },
            { data: 'openid' },
            { data: 'created_at' }
        ],
        language: {
            processing: "加载中...",
            search: "搜索：",
            lengthMenu: "每页显示 _MENU_ 条记录",
            info: "第 _START_ - _END_ 条，共 _TOTAL_ 条",
            paginate: { previous: "上一页", next: "下一页" },
            zeroRecords: "未找到匹配结果"
        },
        order: [[0, "asc"]],
        pageLength: 10,
        lengthMenu: [5, 10, 20, 50]
    });


    // 管理员表格（AJAX 加载）
    const adminTable = $('#adminTable').DataTable({
        serverSide: true,
        processing: true,
        ajax: function (data, callback) {
            const page = Math.floor(data.start / data.length) + 1;
            $.getJSON(`admin_list/?page=${page}&per_page=${data.length}`, function(res) {
                callback({
                    recordsTotal: res.total,
                    recordsFiltered: res.total,
                    data: res.data
                });
            });
        },
        columns: [
            { data: 'id' },
            { data: 'username' },
            { data: 'created_at' }
        ],
        language: {
            processing: "加载中...",
            search: "搜索：",
            lengthMenu: "每页显示 _MENU_ 条记录",
            info: "第 _START_ - _END_ 条，共 _TOTAL_ 条",
            paginate: { previous: "上一页", next: "下一页" },
            zeroRecords: "未找到匹配结果"
        },
        order: [[0, "asc"]],
        pageLength: 10,
        lengthMenu: [5, 10, 20, 50]
    });

});
</script>

</body>
</html>
